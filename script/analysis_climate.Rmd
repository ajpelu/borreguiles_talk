---
title: "Explore trends of climatic variables of SN (above 2300 msnm)"
author: "AJ Perez-Luque (@ajpelu)"
date: "2015 April"
output:  
    md_document:
      variant: markdown_github
---

```{r}
library('plyr')
library('dplyr')
library("ggplot2")
library('broom') # tidy results
```

## Prepare data
```{r}
# Prepare data
di <- '/Users/ajpelu/ownCloud/MS/CONGRESO_AEET2015/borreguiles/borreguiles_talk'

data <- read.csv(file=paste(di, '/data/climate_2300.csv', sep=''), header=TRUE, sep=";")

df <- tbl_df(data)
```

## Explore data from 1980 to 2010 
#### A plot of the evolution of temperatures from 1980 to 2010
```{r}
ts_temp <- df %>% filter(ano >= 1980) %>%
  filter(codigo == 'tmin' | codigo == 'tmax') %>% 
  mutate(codigo = revalue(codigo, c("tmin" = "Minimum", "tmax" = "Maximum"))) %>% 
  mutate(valorC = valor / 10) %>%
  group_by(ano, codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valorC)
  
ggplot(ts_temp, aes(x=ano, y=mean, group=codigo)) + 
  geom_point(aes(group=codigo, shape=codigo), size=3) +
  geom_smooth(method='loess') +
  theme_bw() + xlab('year') + ylab('Temperature') + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())  
```

#### A plot of the evolution of precipitation from 1950 to 2010
```{r}
ts_precip <- df %>% 
  filter(codigo == 'precip') %>% 
  mutate(codigo = revalue(codigo, c("precip" = "Precipitation"))) %>% 
  group_by(ano, codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valor)
  
ggplot(ts_precip, aes(x=ano, y=mean)) + 
  geom_point(size=3) +
  geom_smooth(method='loess') + 
  theme_bw() + xlab('year') + ylab('Precipitation') + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())  
```

## Comparing results 
### Differences between decades
* Diferences between 1980's and 2000's values of temperatures and precipitation
* t-test 

```{r}
# Temperatures for all pixels 
t80 <- df %>% 
  filter(ano >= 1980, ano <= 1990) %>%
  filter(codigo == 'tmin' | codigo == 'tmax') %>% 
  mutate(valorC = valor / 10) %>%
  group_by(cli_celda_id, codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valorC) 

t00 <- df %>% 
  filter(ano >= 2000, ano <= 2010) %>%
  filter(codigo == 'tmin' | codigo == 'tmax') %>% 
  mutate(valorC = valor / 10) %>%
  group_by(cli_celda_id, codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valorC) 

# T.test of tmin 
tmin80 <- t80 %>% filter(codigo == 'tmin')
tmin00 <- t00 %>% filter(codigo == 'tmin')

t.test(tmin80$mean, tmin00$mean, paired = TRUE) 
tidy(t.test(tmin80$mean, tmin00$mean, paired = TRUE))

# T.test of tmax 
tmax80 <- t80 %>% filter(codigo == 'tmax')
tmax00 <- t00 %>% filter(codigo == 'tmax')

t.test(tmax80$mean, tmax00$mean, paired = TRUE) 
tidy(t.test(tmax80$mean, tmax00$mean, paired = TRUE))


# Get mean of 1980's 
mean80 <- df %>% 
  filter(ano >= 1980, ano <= 1990) %>%
  filter(codigo == 'tmin' | codigo == 'tmax') %>% 
  mutate(valorC = valor / 10) %>%
  group_by(codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valorC) %>%
    mutate(timerange = "1980's")

# Get mean of 2000's 
mean00 <- df %>% 
  filter(ano >= 2000, ano <= 2010)%>%
  filter(codigo == 'tmin' | codigo == 'tmax') %>% 
  mutate(valorC = valor / 10) %>%
  group_by(codigo) %>%
  summarise_each(funs(mean, sd,se=sd(.)/sqrt(n())), valorC) %>%
  mutate(timerange = "2000's")

mean10 <- rbind(mean80, mean00)
mean10 







